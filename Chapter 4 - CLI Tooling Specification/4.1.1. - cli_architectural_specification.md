# Title â€” Secure Signing CLI Tool (Architectural Specification)

---

## ğŸ§  Purpose

> Design a command-line signing tool that enforces secure behaviors **independent of frontends**, focusing on:

- Canonical `txintent` validation
- Role-based policy enforcement
- Client integrity enforcement (hash-checking)
- Threat-aware UX

---

## ğŸ“¦ Key CLI Features

| Command                 | Purpose                                                     |
| ----------------------- | ----------------------------------------------------------- |
| `review`                | Parse and display a `txintent.json` with semantic rendering |
| `validate-intent`       | Validate schema + compute and verify canonical hash         |
| `check-policy`          | Enforce execution policies (signer threshold, time, roles)  |
| `sign`                  | Sign only if all checks pass â€” hash, policy, role           |
| `simulate` _(optional)_ | Dry-run transaction buffer against local Solana node        |
| `log`                   | Output timestamped approval tuple `{pubkey, hash, policy}`  |

---

## ğŸ§­ Signing Flow UX (High-Security Path)

```
User loads txintent.json â†’
    CLI parses â†’
    Shows canonical summary (semantic) â†’
    Validates intent hash â†’
    Validates client hash â†’
    Enforces policy (timelock, threshold, signer role) â†’
    Signs (if all pass) â†’
    Emits log tuple
```

---

## ğŸ§ª CLI Behaviors: Defined

| Step                     | Behavior                                                                      |
| ------------------------ | ----------------------------------------------------------------------------- |
| **Load Intent**          | Load and parse `txintent.json`. Show key fields: vault, action, dest, amount  |
| **Canonical Hash Check** | Recalculate SHA256, compare to embedded `intent_hash` field                   |
| **Client Hash Check**    | Compare declared frontend hash to locally stored value or fetched IPFS tag    |
| **Role Validation**      | Ensure signer is part of role in vault config (e.g., "executor" â‰  "proposer") |
| **Policy Enforcement**   | If `min_signers=3`, validate actual vault config; check timelock              |
| **Dry Run (Optional)**   | Simulate tx using `simulate_transaction` RPC                                  |
| **Sign**                 | Confirm with hardware wallet or offline device                                |
| **Emit Log**             | Output `sign_log.json` or IPFS-published tuple:                               |

```json
{
  "pubkey": "SignerXYZ...",
  "intent_hash": "deadbeef...",
  "timestamp": "2025-04-18T21:45Z",
  "client_hash": "abc123...",
  "vault_id": "VaultABC..."
}
```

---

## ğŸ” Security-First CLI UX

| UX Principle          | Implementation                                                  |
| --------------------- | --------------------------------------------------------------- |
| **Fail Closed**       | CLI refuses to sign if any check fails                          |
| **No Auto-Execution** | CLI cannot trigger execution (sign-only mode)                   |
| **Trust Nothing**     | CLI doesnâ€™t trust RPCs, frontends, or buffers                   |
| **OOB Verification**  | Supports QR printout of `intent_hash` for multisigner consensus |
| **Airgapped Mode**    | Allow offline review + signature via Ledger/Yubi export flow    |

---

## ğŸ“ Threat Mitigation Coverage

| Threat               | CLI Feature                                                      |
| -------------------- | ---------------------------------------------------------------- |
| Intent Mismatch      | Canonical `validate-intent` before signing                       |
| Musked UX            | Enforce `client_hash` match                                      |
| Plugin Abuse         | Warn if `transaction_type=custom` and no plugin policy present   |
| Threshold Drift      | Enforce policy floor from `txintent.execution_policy`            |
| Last Signer Exploits | Enforce timelock; warn if signer is last in quorum               |
| Ghost Signer Bot     | Force biometric/hardware confirmation                            |
| All Signers Deceived | CLI provides non-UI context; supports independent OOB validation |

---

## ğŸ“ Directory Planning

```
/cli-secure/
â”œâ”€â”€ README.md
â”œâ”€â”€ example.txintent.json
â”œâ”€â”€ demo.txt (CLI output)
â””â”€â”€ sign_log.json
```

---

## âœ… Summary

**This CLI tool architecture includes:**

- ğŸš¦ Command-level control points
- ğŸ” Zero-trust design logic
- ğŸ” Specific UX to **interrupt** signing if any risk is present
- ğŸ“ Mapped to **every threat vector** from earlier milestones
